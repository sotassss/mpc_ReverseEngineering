# 仕様書: OCR処理およびExcel出力システム

## 目次
1. [システム概要](#1-システム概要)
2. [ファイル構成](#2-ファイル構成)
3. [設定ファイルの詳細](#3-設定ファイルの詳細)
4. [OCR処理の詳細](#4-ocr処理の詳細)
5. [データ出力の方法](#5-データ出力の方法)
6. [エラーハンドリング](#6-エラーハンドリング)
7. [動作環境と依存関係](#7-動作環境と依存関係)
8. [保守とサポート](#8-保守とサポート)
9. [まとめ](#9-まとめ)

---

## 1. システム概要


このシステムは、OCR（光学式文字認識）を利用して文書から情報を自動的に抽出し、最終的にその情報をExcelファイルとして出力することを目的としています。特に請求書の処理を中心に設計されており、効率的なワークフローを提供します。

### OCR処理の必要性

OCR技術は、印刷物や手書きのテキストをデジタルデータに変換する重要な手段です。本システムでは、請求書などの文書から必要な情報を抽出し、手動でのデータ入力作業を削減することで、業務の効率化を図ります。OCRを活用することで、正確かつ迅速にデータを収集し、デジタルデータとして管理することが可能になります。

### 対象となるデータ形式

システムは、主に以下のデータ形式に対応しています。

- **PNGフォーマット**: 請求書や関連文書の画像ファイル。
- **JSONファイル**: 画像処理の際に使用されるメタデータや情報。
- **Excelフォーマット**: 最終出力として各請求書データを整理したファイル形式。

### システムの全体的なアーキテクチャ

システムは、一連のPythonスクリプトから構成されており、以下の主要なステップから成り立っています。

1. **画像の探索とOCR適用**
   - `1_ocr_only.py`により、指定フォルダ内のPNG画像を探索し、OCR処理を実施。この時点では認識結果やバウンディングボックスの描画は行わず、シンプルにテキストを抽出します。

2. **画像の方向修正**
   - `2_change_direction.py`によって、OCRの結果に基づいて画像のスキューを修整し、正しい方向に回転させます。このステップにより、OCRの精度向上が期待されます。

3. **画像の水平化**
   - `3_make_flat.py`では、`aspose.ocr`ライブラリを利用して画像の傾きを調整し、水平な状態にします。これによりOCR処理の精度がさらに向上します。

4. **最終OCR処理**
   - `4_ocr_all.py`において、平坦な画像に対して改めてOCRを適用し、最終的なテキストデータを取得します。

5. **データの抽出と出力**
   - `5_search_all.py`では、OCR結果から特定の項目（項目名、単価、個数、金額）を抽出して表示します。これにより、請求書の特定データを迅速に確認できます。

6. **エクセルファイルへの出力**
   - `LargeFile.py`により、処理された情報をExcelファイルにエクスポートします。これには、データの整理や集計機能が組み込まれています。

全体として、これらのスクリプトは相互に連携し、文書からの情報抽出を自動化する効率的なフローを形成しています。このワークフローにより、大量の請求書データを迅速かつ正確に処理することが可能です。

## 2. ファイル構成


このセクションでは、システムで使用されているすべてのファイルについて、その役割や機能、ファイル間の関係を詳細に解説します。具体的には、YAML設定ファイル、Pythonスクリプト、およびその出力形式であるExcelファイルについて説明します。

### 2.1 YAML設定ファイル

#### `config.yml`
- **パス**: `code/code_sample_python/config.yml`
- **概要**: このファイルはYAML形式で記述された設定ファイルです。設定ファイルは、アプリケーションの動作に必要な環境設定やパラメータを定義するために使用され、YAML形式は人間が読みやすく、階層構造を持つデータを簡潔に表現することができます。
- **内容**: 具体的な内容はセンシティブな情報が含まれているため、非表示ですが、一般的には以下のような情報が含まれることが多いです。
  - データベースの接続情報
  - APIキー
  - その他環境依存の設定

### 2.2 Pythonスクリプト

#### `LargeFile.py`
- **パス**: `code/code_sample_python/LargeFile.py`
- **役割**: このスクリプトは、複数のExcelファイルからデータを読み込み、特定の条件に基づきデータを置き換え、結果を新しいExcelファイルとして保存する処理を行います。
- **主要な機能**:
  - **`replace_missing_values`**: 各Excelファイルを引数として受け取り、条件に基づき値を置き換えます。具体的な処理内容は以下の通りです。
    - ファイル1〜4の各ワークブックを読み込む。
    - C列（税額）、B列（小計）、D列（合計）、F列の値が'*'である場合、他のワークブックの値で置き換えます。ここで、C列の税額は、特定の閾値以下の値で置き換えられます。
    - 処理が完了した後、結果を指定のパスに新しいExcelファイルとして保存し、"completed"と出力します。
- **変数の説明**:
  - `file1_path`, `file2_path`, `file3_path`, `file4_path`: 各Excelファイルのパス。
  - `integrated_path`: 統合ファイルのパス。
  - `output_path`: 結果ファイルの保存先。
  - `wb1`, `wb2`, `wb3`, `wb4`: 各ファイルに対応するワークブックオブジェクト。
  - `ws1`, `ws2`, `ws3`, `ws4`: 各ワークブックのアクティブなシートオブジェクト。
  - `max_row`, `max_col`: 各シートの最大行数および最大列数。
  
#### `請求書処理関連スクリプト`
- **パス**: `code/code_sample_python/LargeFile.py`（同ファイル内に異なる機能を含む）
- **役割**: このソースコードは、請求書を処理する一連のスクリプトを集約し、各フォルダ内のPNGファイルやOCR解析結果を元にExcelファイルに出力する処理を行います。
- **主要な機能**:
  1. **`process_png_folder(base_folder)`**: 指定されたフォルダ内の特定のサブフォルダに対し、PNGファイルを処理します。
  2. **Excel出力処理**: 処理された情報をExcelファイルとして出力します。Pandasを用いてDataFrameを作成し、請求書の基本情報を整理します。
  3. **エラー処理**: 特定の条件に基づいて発生するエラーに対処するための注意喚起が記載されています。
  4. **データの結合**: 履歴の各フォルダのデータを統合します。これにより、複数のソースからの情報を一つのファイルにまとめることができます。

### 2.3 出力形式（Excelファイル）

このスクリプトから生成されるExcelファイルは、処理されたデータが整理されて保存される形式です。具体的な生成方法やファイル名、フォーマットなどの詳細は、ソースコードの挙動により異なりますが、一般的には以下のような情報が含まれます。
- 処理結果のデータを各シートに格納。
- データ整形や不要なセルの削除、フォーマット設定など。

全体として、このシステムはYAML設定ファイルによる環境設定を基盤とし、Pythonスクリプトによるデータ処理を通じて、最終的に整理されたExcelファイルを出力する流れを確立しています。

## 3. 設定ファイルの詳細


`config.yml` ファイルは、YAML形式で記述された設定ファイルで、アプリケーションの動作に必要な環境設定やパラメータを定義しています。このファイルは、人間が読みやすく、階層構造を簡潔に表現できるため、設定情報の管理に広く利用されています。以下では、ここに含まれる設定項目の一般的な内容とその用途を説明します。

### 設定項目の説明

#### 1. データベース接続設定
- **項目名**: `database`
  - **用途**: アプリケーションが接続するデータベースに関する設定情報を提供します。
    - **例**:
      - `host`: データベースサーバーのホスト名
      - `port`: 接続ポート
      - `username`: データベースユーザー名
      - `password`: データベースパスワード
      - `dbname`: データベース名

#### 2. API設定
- **項目名**: `api`
  - **用途**: 外部APIとの連携に必要な情報を設定します。
    - **例**:
      - `base_url`: APIのベースURL
      - `api_key`: APIキー

#### 3. ロギング設定
- **項目名**: `logging`
  - **用途**: アプリケーションのロギングに関する設定を管理します。
    - **例**:
      - `level`: ログの出力レベル（例: `DEBUG`, `INFO`, `WARNING`, `ERROR`）
      - `file`: ログファイルの出力先パス

#### 4. その他の環境依存設定
- **項目名**: `environment`
  - **用途**: アプリケーションが動作する環境に依存する設定を含みます。
    - **例**:
      - `mode`: 環境モード設定（例: `development`, `production`）

### 必要な設定値

アプリケーションの正常な動作のためには、上記の設定項目の中で以下の値が特に重要です。

- `database.host`
- `database.username`
- `database.password`
- `api.base_url`
- `logging.level`

これらの項目は正確に設定されている必要があり、欠如している場合にはアプリケーションが正常に機能しない可能性があります。

### デフォルト設定

各項目にはデフォルト値が設定されている場合があります。デフォルト値はアプリケーションの初期状態や開発中に便利な場合がありますが、プロダクション環境では適切な値に変更する必要があります。

- `logging.level`: `INFO`（デフォルト）
- `environment.mode`: `development`（デフォルト）

これらのデフォルト設定はアプリケーションの動作に影響を与えるため、環境に応じて確認・修正が推奨されます。

---

具体的な内容に関しては、センシティブな情報が含まれているため、詳細な設定値や個別の値については明示することはできません。

## 4. OCR処理の詳細


このセクションでは、画像からテキストを抽出するOCR（光学式文字認識）プロセスについて詳述します。主に使用されている技術、処理対象の画像の要件、OCRの設定やパラメータについて解説します。

### OCR技術の選択理由

OCR技術には多くの選択肢がありますが、現在使用されている技術は、精度が高く、様々なフォーマットの文書に対応できる柔軟性があるため選ばれています。具体的なライブラリや技術の詳細はソースコードに記載がないため、利用されているOCR技術の詳細については非表示です。

### 処理対象となる画像の要件

OCR処理を実施する上で、処理対象となる画像は以下の要件を満たす必要があります：

1. **フォーマット**: 主にPNG形式の画像ファイルが対象となります。
2. **解像度**: 高解像度の画像が推奨されており、文字が明瞭に見えることが重要です。低解像度やぼやけた画像は認識精度が低下します。
3. **構造**: 文書が整ったレイアウトであること。手書きの文字や複雑な背景を持つ画像は認識精度に影響を与えるため注意が必要です。

### OCRの設定やパラメータ

OCRプロセスにはいくつかの設定やパラメータが関与しています。ソースコード内で利用されている関数やパラメータは下記の通りです：

1. **関数の役割**:
   - `function_ocr.ocr_only_function`: 画像に対してOCRを実行するための関数で、処理フローの中で非常に重要な役割を担っています。
   - `function_ocr.ocr_function`: 平坦にした画像に対してOCR処理を実行し、結果を取得する関数です。

2. **画像処理の順序**:
   - 画像の回転や水平化はOCR処理を行う前に必要です。これにより、文字が正しい配置となり、認識精度が向上します。
   - スクリプトの中での処理の流れは、まず画像フォルダを探索し、次に必要に応じて画像を正しい方向に回転させ、その後平坦化し、最終的にOCRを実施する形で構成されています。

3. **出力の保存**:
   - OCR結果は新しいフォルダに保存され、後続の処理で参照されます。結果の形式や詳細な構造は非表示です。

### 結論

このOCR処理は、一連の処理経路を通じて、文書から情報を自動的に抽出するための強力な仕組みを提供しています。画像の要件を満たし、適切な設定で実行することで、精度の高い結果を得ることが可能です。各スクリプトが協調して動作することで、大量の文書に対する情報抽出を効率化します。

## 5. データ出力の方法


このセクションでは、OCR処理後に生成されるExcelファイルのフォーマット、出力先、およびその利用方法について詳細に説明します。また、出力データに含まれる情報の構成や具体例も示します。

### 出力データのフォーマット

出力されるExcelファイルは、請求書から抽出されたデータを整理し、以下のような構成を持つことが想定されます。

- **シート名**: 各請求書に関連する情報をまとめたシート。例えば、「請求書_20230901」など、請求書の日付や識別子が含まれる。

#### 列の構成

| 列名       | 内容                                      |
|------------|-------------------------------------------|
| A列        | 請求書番号                                |
| B列        | 税額                                      |
| C列        | 小計                                      |
| D列        | 合計                                      |
| E列        | 項目名                                    |
| F列        | 単価                                      |
| G列        | 個数                                      |
| H列        | 金額                                      |
| I列        | その他のメタ情報（例：処理日時、処理結果） |

### 出力先

Excelファイルは、指定された`output_path`に保存されます。このパスは、各関数の引数として受け取ることができ、出力されたファイルは基本的に以下の地点に格納されます：

- **出力先パス**: 指定されるディレクトリ内
- **ファイル名**: 一意の関数に基づき生成されたファイル名（例：`output_請求書_20230901.xlsx`）

#### 保存処理

処理が完了した後、全てのデータが一つのExcelファイルに統合され、結果として新しいファイルが生成されます。このファイルは、ユーザーによって容易にアクセス可能です。

### 利用方法

生成されたExcelファイルは、以下の用途に利用されることが想定されます：

1. **ビジネスレビュー**: 請求書の内容やデータを使用して、ビジネス上の決定を行うためのレビュー資料として活用。
2. **データ分析**: エクセルソフトウェアを利用して、売上分析やトレンド分析を行うための入力データとして利用。
3. **監査**: 財務監査およびコンプライアンスチェックのための監査資料。
4. **今後の参照**: 過去の取引記録として、後に確認するための参考資料として保管。

### 出力データの例

以下に、出力されるExcelファイルの一例を示します。

| 請求書番号 | 税額 | 小計 | 合計 | 項目名 | 単価 | 個数 | 金額 | その他のメタ情報          |
|------------|------|------|------|--------|------|------|------|---------------------------|
| INV-001    | 1000 | 10000| 11000| 商品A  | 500  | 20   | 10000| 2023/09/01 10:00:00 発行 |
| INV-002    | 2000 | 20000| 22000| 商品B  | 1000 | 20   | 20000| 2023/09/02 11:00:00 発行 |

このように、出力データは整理された形で保存され、後にビジネス上の意思決定をサポートするための貴重な情報源となります。

## 6. エラーハンドリング


このセクションでは、システム内で発生し得るエラーの種類と、それに対する処理方法について詳述します。特に、OCR処理中のエラーとデータ出力時のエラーに焦点を当て、エラーメッセージやログの管理方法について説明します。

### 6.1 OCR処理中のエラー

#### 6.1.1 発生するエラーの種類
OCR処理中に発生する可能性のあるエラーには、以下のようなものがあります。

- **ファイル読み込みエラー**: 指定された画像ファイルが存在しない、または破損している場合。
- **OCRエラー**: OCRライブラリが画像を処理できず、認識結果を取得できない場合。
- **メモリエラー**: 大きな画像ファイルを処理する際にメモリ不足が発生する場合。

#### 6.1.2 エラーハンドリングの実装
これらのエラーに対して、以下のようなエラーハンドリングが実施されています。

- 画像ファイルが存在しない場合は、エラーメッセージをログに記録し、処理をスキップする。
- OCRエラーが発生した場合には、再試行を行うか、エラーメッセージをログに出力し、処理を中断する。
- メモリエラーが発生した場合、現在の処理を終了し、ユーザーに注意を促すメッセージを表示する。

#### 6.1.3 エラーメッセージとログ管理
エラーが発生した際には、以下の方針に基づいてエラーメッセージやログが記録されます。

- **エラーメッセージ**: エラーの種類と発生箇所、原因となったファイル名を含む詳細なメッセージを構築します。
- **ログファイル**: エラーメッセージは指定のログファイルに保存され、後で確認できるようにします。ログには、エラー発生時のスタックトレースも含まれます。

### 6.2 データ出力時のエラー

#### 6.2.1 発生するエラーの種類
データ出力時に発生する可能性のあるエラーには、以下のものがあります。

- **ファイル書き込みエラー**: 出力先ディレクトリが存在しない、または書き込み権限がない場合。
- **データ型エラー**: 不正なデータ型がDataFrameに含まれているため、Excelファイルへの書き込みが失敗する場合。
- **出力フォーマットエラー**: 出力先のフォーマットが不正なため、Excelファイルが作成できない場合。

#### 6.2.2 エラーハンドリングの実装
データ出力時のエラーに対しては、次のようなエラーハンドリングを実施しています。

- 出力先フォルダが存在しない場合には自動的に作成し、書き込み権限の有無を確認します。
- DataFrameに不正なデータ型が含まれる場合、エラーを検出し、対象データの詳細をログに記録します。
- 出力フォーマットに関して不正な値がある場合、処理を中断し、ユーザーへのエラーメッセージを表示します。

#### 6.2.3 エラーメッセージとログ管理
データ出力時にエラーが発生した場合、以下のようにエラーメッセージとログの管理が行われます。

- **エラーメッセージ**: エラーの種類、原因、および発生した処理のコンテキストを示すメッセージ。
- **ログファイル**: エラー内容はログファイルに記録され、特に出力失敗したファイルの情報を含めます。

これにより、後からのデバッグやエラー分析に便利な状況を整えています。各エラーについての詳細は、ログファイルを参照することで確認可能です。

## 7. 動作環境と依存関係


このセクションでは、システムが必要とする動作環境および依存関係について詳細に説明します。

### 動作環境

以下は、システムを正常に動作させるために必要な基本的な動作環境です。

- **オペレーティングシステム**: 
  - Windows
  - macOS
  - Linux (特にUbuntu)

- **Python バージョン**: 
  - Python 3.6 以上

### 依存関係

システムが動作するためには、以下のライブラリが必要です。これらのライブラリは、必要に応じて`requirements.txt`ファイルを通じてインストールできます。

#### 必要なライブラリ

1. **aspose-ocr**:
    - 利用目的: 画像からテキストを抽出するためのOCR機能を提供します。

2. **PyYAML**:
    - 利用目的: YAML形式の設定ファイルを読み込むために使用します。

3. **おそらく利用されるライブラリ**（詳細はコードによって異なるため、具体的には確認が必要です）:
    - Pillow: 画像処理に関連する操作を行うため。
    - NumPy: 数値計算を効率的に行うため。

#### インストール手順

依存関係をインストールするためには、以下のコマンドを使用します。

```bash
pip install -r requirements.txt
```

#### その他

- 設定ファイル（`config.yml`）には、データベース接続情報やAPIキーなど、動作に必要なセンシティブな情報が含まれています。このファイルは適切に管理され、必要な環境で読み込まれるべきです。

以上が、システムを正常に運用するために必要な動作環境と依存関係の詳細です。各種ライブラリや設定に関しては、最新の情報を確認し、必要に応じて更新を行ってください。

## 8. 保守とサポート


このセクションでは、システムの保守およびサポート体制について詳述します。ユーザーサポートの方法、保守契約に関する情報、将来的なアップデートの計画について以下に説明します。

### ユーザーサポート

ユーザーサポートは、利用者がシステムを効果的に活用できるようにするための重要な要素です。以下の方法でサポートを提供します。

- **ヘルプデスク**: 電子メールや電話を通じての問い合わせに対応するためのヘルプデスクを設置します。利用者は問題や質問を報告でき、迅速にサポートを受けることができます。
  
- **FAQセクション**: よくある質問（FAQ）をまとめたセクションをウェブサイト上に設け、ユーザーが自己解決できる情報を提供します。

- **ユーザーマニュアル**: システムの使用方法やトラブルシューティングに関する詳細なドキュメントを提供します。これにより、ユーザーはシステムの各機能について理解を深めることができます。

- **オンラインサポートフォーラム**: ユーザー同士が情報交換や問題解決のためのディスカッションを行えるオンラインフォーラムを提供します。

### 保守契約

本システムには、保守契約を通じた定期的なメンテナンスとサポートを提供します。契約内容は以下の通りです。

- **定期メンテナンス**: システムの性能を最適化するために、定期的なメンテナンスを行います。これには、ソフトウェアのバグ修正、パフォーマンスの向上、新機能の追加が含まれます。
  
- **障害対応**: 重大なシステム障害が発生した場合の対応策を用意しています。迅速に対応し、業務に最小限の影響を与えることを目指します。

- **アップデートとパッチ**: システムの安全性を維持するために、セキュリティパッチや機能の改善を定期的に提供します。

### 将来的なアップデートの計画

システムの持続的な改善を目指し、将来的なアップデートについての計画を策定しています。以下の点に焦点を当てる予定です。

- **新機能の追加**: ユーザーからのフィードバックや市場のニーズに基づいて、新しい機能を定期的に導入します。

- **ユーザーインターフェースの改善**: 利便性を向上させるためのUI/UX改善に注力し、ユーザーがより使いやすく感じるようにします。

- **パフォーマンスの最適化**: システムの速度と効率性を向上させるために、定期的なパフォーマンステストを実施し、必要に応じた最適化を行います。

このような保守とサポート体制を通じて、ユーザーが本システムを安心してご利用いただけるよう努めてまいります。

## 9. まとめ


本ドキュメントでは、請求書処理を自動化するためのシステムについて詳述しました。このシステムは、OCRを用いた文書からの情報抽出と、処理結果をExcelファイルに出力する一連の機能を持っています。

### システムの価値
本システムの主な価値は、以下の点に集約されます：

1. **効率化**: 手動で行っていた請求書の処理を自動化することで、作業時間を大幅に短縮します。複数の画像処理段階を経て、仕分け、回転、平坦化、OCRの実行といった一連の工程が一つのフローで実施されます。

2. **精度の向上**: OCR技術の利用により、手動では見落とされがちな情報も自動的に取得できます。さらに、処理ステップで画像の方向を正しく修正することで、認識精度が向上しています。

3. **データ集約**: 最終的に、異なるソースから得られた情報をまとめてExcelファイルとして出力します。これによりデータ管理が統一され、使いやすい形式で情報を提供できます。

### 利用する際の注意点

このシステムを利用する際には、以下の点に注意が必要です：

1. **センシティブ情報の扱い**: 設定ファイルやその他の処理の中で扱う情報にはセンシティブなデータが含まれる場合があります。そのため、ファイルアクセスや情報取り扱いについて適切なセキュリティ措置を講じることが重要です。

2. **エラーハンドリング**: 特定の条件下でのエラー発生を考慮した実装となっていますが、常にエラーに対する十分なテストと確認が必要です。特にOCRの結果に基づく情報抽出では、状況に応じた更なる校正が必要になることもあります。

3. **環境設定**: YAML形式の設定ファイルにはさまざまな環境依存の設定が含まれます。システムの正しい動作を保証するためには、これらの設定が正確に行われていることを確認することが重要です。

### 期待される効果

本システムは、請求書処理の自動化を通じて業務の効率化を図り、リソースの最適化とエラーの削減を実現することが期待されます。自動化されたプロセスにより、企業はより戦略的な意思決定にリソースを集中させることが可能になります。この結果、長期的な業務改善と利益率の向上を見込むことができます。

