# 業務系アプリケーションの仕様書

## 目次
1. [システム概要](#1-システム概要)
2. [ファイル構成](#2-ファイル構成)
3. [データ構造定義](#3-データ構造定義)
4. [業務ロジック](#4-業務ロジック)
5. [エラーハンドリング](#5-エラーハンドリング)
6. [セキュリティ設計](#6-セキュリティ設計)
7. [システムテスト](#7-システムテスト)
8. [デプロイメント手順](#8-デプロイメント手順)
9. [運用・保守ガイドライン](#9-運用・保守ガイドライン)

---

## 1. システム概要


本システムは、業務アプリケーションにおけるデータ管理を効率化するために設計されたCOBOLプログラム群から構成されています。主な目的は、特定のビジネスニーズに基づいてデータ構造を定義し、業務処理を円滑に行うことです。システムは、業務に必要なデータ要素を構造的に管理し、適切なフォーマットでデータを処理することを目指しています。

### 主な機能
- **データ定義**: 各COBOLプログラムは、業務特有のデータ項目を定義しており、数値や文字列のフィールドを含むデータ構造を構築します。これにより、データの整合性と効率的な管理が可能になります。
- **業務ロジックの実装**: プログラムは、具体的な業務ロジックを実装しており、データ処理や集計に関する機能を提供します。これにより、ビジネスプロセスの自動化が促進されます。
- **ユーザーデータ管理**: 複数のデータフィールドを持つ構造により、多様なユーザーデータを効率的に管理・処理することができる機能があります。

### 技術スタックとアーキテクチャ
システムはCOBOL言語を使用して実装されており、主に以下のデータ構造で構成されています：
- **変数定義**: 整数や文字列などのデータ型が明記されており、PIC句を使用して具体的なデータフォーマットが定義されています。
- **データグルーピング**: 05レベルのデータ項目によるグループ化が行われており、ビジネスロジックの実行における重要な部分を形成しています。
- **コメントとメタ情報**: 各プログラムの冒頭には目的や著者に関するコメントが記載されており、設計意図が明示されています。

このように、システム全体は業務プロセスのデータ管理を支援するための堅牢な基盤を提供することを目的としています。

## 2. ファイル構成


本セクションでは、本プログラムに含まれるCOBOLファイルの役割や関連性を整理し、各ファイルの目的や使用されるデータ構造を規定します。特に、データフィールドの名称、データ型、サイズについて一貫した表現を用いて記述します。

### 2.1 OJUSINJ.CBL

このCOBOLプログラムは、特定のデータ構造に基づいて情報を処理するために設計されています。

#### 2.1.1 レコード定義
- **データ構造名**: 儗僐乕僪
- **フィールド定義**:
  - フィールドは`PIC`（Picture）句を使用して定義されており、数値型や文字列型が含まれています。

#### 2.1.2 キーの定義
- **主キー**: RECORD KEY
- **代替キー**: 複数の代替キーが定義され、一意にレコードを識別します。

#### 2.1.3 データグループ
- 各グループは数値、文字列、日付、ステータス情報を含み、各項目の組み合わせにより複雑なデータを形成します。

### 2.2 H_HOKOK.CBL

このプログラムは、特定のデータ構造を定義し、ファイル入出力操作を行います。

#### 2.2.1 ファイル宣言
- **ファイル名**: 俫曬崘彂俥
- **アクセス方法**: INDEXEDアクセス
- **設定項目**: レコードキー、ロックモード

#### 2.2.2 データ構造の定義
- **データ構造名**: 儗僐乕僪
- **フィールド定義**:
  - 複数のサブフィールドがあり、リデファインを使用して同じメモリ領域に異なる視点からアクセス可能です。

#### 2.2.3 サブグループの定義
- グループはリデファインされたサブグループがあり、効率的なデータ処理が可能です。

### 2.3 Kinsetu.cbl

このプログラムは、特定のデータ構造を定義し、データの格納と処理を目的としています。

#### 2.3.1 データ構造の定義
- **データ構造名**: 儗僐乕僪
- **フィールド定義**:
  - 数値データ型（例: PIC 9）で定義されたフィールドが含まれています。

#### 2.3.2 サブフィールド
- **サブフィールド名**: 儗僐乕僪僉乕
- **配列定義**: OCCURS 100で、同じ形式のデータを最大100個まで含むことが可能です。

### 2.4 SEKIROK.CBL

このプログラムは、COBOL97で書かれ、主に変数や配列を定義するデータ部から構成されています。

#### 2.4.1 データ構造の定義
- **データ構造名**: 儗僐乕僪
- **主要フィールド**:
  - **巤弍榓楋擭寧**: 数値を保持するためのフィールド（例: PIC 9, PIC 9(2)など）。
  - **姵幰僐乕僪**: 別のデータ構造で、数値情報を保持。

#### 2.4.2 配列の管理
- 各種数値情報を9つの配列で管理し、情報の記録やアクセスを効率化しています。

### 2.5 概要

各COBOLファイルは、定義されたデータ構造とフィールドによって、特定のビジネスロジックに従ったデータの格納や処理を行います。全体的な処理内容については非表示のため具体的なロジックを把握することはできませんが、各種データフィールドが重要な役割を果たしていることが示されています。

## 3. データ構造定義


このセクションでは、COBOLプログラム内で定義されているすべてのデータ構造について詳述します。各データ構造は、変数群を定義するために PAC（Picture Clause）が利用されており、作成されたスキーマはそれぞれのデータフィールドの型や役割を容易に理解できる形式で表示されます。

### データ構造概要

以下では、主要なデータ構造のスキーマと各フィールドの説明を行います。

#### 1. 儗僐乕僪
- **レベル**: 01
- **説明**: データコンテナの最上位レイヤーであり、全てのデータフィールドを格納します。この構造体は内部に複数のサブフィールドを持ちます。

##### サブフィールド
- **レベル**: 03 儗僐乕僪僉乕
  - **説明**: データ構造内のサブセクション。異なるデータフィールドが含まれています。
  - **フィールド**:
    - `曐尟庬暿`: PIC 9(2) - 整数型のフィールド。特定項目の識別子やカウントに使用されると推測される。
    - `曐尟幰斣崋`: PIC X(10) - 文字列型のフィールド。名称やコードを格納。

- **レベル**: 03 儗僐乕僪僨乕
  - **説明**: 内部データブロックで、さまざまなフィールドを含む。
  - **フィールド**:
    - `曐尟幰僇僫`: 文字列フィールド（詳細は不明）。
    - `曐尟幰廧強`: ネストされたフィールド（詳細は不明）。
    - `揹榖斣崋`: ネストされたフィールド（詳細は不明）。
    - `FILLER`: データのパディングエリアとして無視される領域。

#### 2. 懡晹埵峉弅屻椕椏俀
- **レベル**: 09
- **説明**: 主データ構造。グループデータがネストされています。

##### グループデータ
- **レベル**: 07 晹埵俁 
  - **フィールド群**:
    - `屻椕俁`: PIC 9(6) - 6桁の数値フィールド。
    - `椻悛朄俁`: PIC 9(4) - 4桁の数値フィールド。
    - `壏悛朄俁`: PIC 9(2) - 2桁の数値フィールド。
    - `揹椕俁`: PIC 9(3) - 3桁の数値フィールド。
    - `彫寁俁`: PIC 9(5) - 5桁の数値フィールド。
    - `挿婜掽尭棪俁`: PIC 9(2) - 2桁の数値フィールド。
    - `挽婜崬彫寁俁`: PIC 9(2) - 2桁の数値フィールド。

#### 3. джㅼеликеи
- **レベル**: 不明
- **説明**: PIC 9(2)型の2つのフィールドから構成されたデータ構造。具体的な用途や機能は不明。

#### 4. в боловсруулах
- **レベル**: 不明
- **説明**: ネストされた複数のフィールドを持つデータ構造で、特定の業務ロジックに基づくデータのグループ化に利用されることが想定される。

#### 5. 懡晹埵崬彘俉
- **レベル**: 不明
- **説明**: 特定の関数またはプロセスに関連するフィールドが定義されているデータ構造。具体的な機能はソースコードからは読み取れないが、業務的な利用が考えられる。

#### 6. その他のフィールド
- **FILLER**: 数字や文字列を格納するためのスペースとして設定されており、無視すべきデータ領域。

### まとめ

このセクションでは、プログラム内で定義された主要なデータ構造を網羅的に記述しました。それぞれのフィールドの型や役割を理解することで、プログラム全体の構造やデータ管理のスタイルを把握する手助けとなります。各データフィールドは特定の業務ロジックに基づいて配置されていると考えられ、その用途の詳細は実装の文脈で把握する必要があります。

## 4. 業務ロジック


このセクションでは、システム内の重要なビジネスプロセスや主要なアルゴリズムに関する情報を、既存のソースコードの内容に基づいて整理します。ビジネスロジックは複数のソースファイルに分散しており、それぞれのファイルで扱われるデータ構造や処理内容は異なりますが、全体を通じて関連する業務プロセスが共通しています。

### 1. データ構造

#### 1.1 取引情報の管理 (`NYUKIN.CBL`)
- **メインレコード (`儗僐乕僪`)**:
  - 顧客の取引に関する基本的な情報を保持します。
  - ネストされた構造体を用いて、取引の詳細情報を管理。
  - 取引主キー、日付情報およびその他の関連情報が含まれている。

#### 1.2 複雑なデータ処理 (`H_souhut.cbl`)
- **データレコード (`儗僐乕僪`)**:
  - 複数の層からなるデータ構造を定義し、特定のビジネスロジックを反映。
  - キー情報 (`曐尟庬暿`, `導俰俬俽`, `曐尟幰斣崋`) に基づくレコードの識別が可能。

#### 1.3 計算処理 (`KEISAN.CBL`)
- **メインデータ構造 (`儗僐乕僪`)**:
  - 数値処理に特化したフィールド構成で、ビジネスロジックに基づくデータ、例えば、計算するための値を保持します。

### 2. ビジネスプロセスの流れ

#### 2.1 取引データの登録
- 入力された顧客の取引情報が後述のデータ構造 (`儗僐乕僪`) に格納されます。
- 各フィールドは、ビジネスルールに基づいて適切な形式（数値または文字列）で管理され、これによりトランザクションの一貫性が保証されます。

#### 2.2 処理ロジック
- 取引情報の更新や計算処理において、メインレコードのフィールドにアクセスし、必要なビジネスロジックを適用します。
- 特に、日付や数値フィールドに対して、必要な演算や条件判定が実施されることで、最終的な出力が生成されます。

#### 2.3 データの保管と取得
- データは特定のキーを使用して効率的に管理され、必要な場合に迅速に取得できるよう設計されています。
- 代替キーを用いた検索機能により、迅速なデータアクセスが実現されています。

### 3. 主なロジックの例

- **計算ロジック**:
  - 各種データフィールドから必要な数値を抽出し、所定の計算手順を経て結果を生成します。
- **条件判定**:
  - ビジネスルールに基づく条件分岐が存在し、特定の条件を満たす場合にのみ処理が実行されます。

### 4. 関連するロジックの整理
- 各ソースコードの関数やロジックは、業務要件に基づいて異なる役割を担っていますが、全体のビジネスプロセスを通じて統一されたデータモデルを利用しています。
- 処理が重複しないようにデータ構造が整備されているため、システムの拡張性や保守性が向上しています。

このように、システムは複雑なビジネスロジックをハンドリングするために慎重に設計されており、それぞれのソースファイルが協調して機能を果たしています。

## 5. エラーハンドリング


このセクションでは、システム内で発生する可能性のあるエラーの種類とその処理方法について簡潔に示します。実装方針を明確にし、具体的なガイドラインを提供します。

### エラーの種類

#### 1. ファイルアクセスエラー
- **説明**: ファイルが存在しない、または読み取り/書き込み権限がない場合に発生します。
- **例外状況**:
  - 指定されたファイル名が不正。
  - ファイルがロックされている。
  - デバイスの故障。

#### 2. データフォーマットエラー
- **説明**: 読み込んだデータが期待されるフォーマットと異なる場合に発生します。
- **例外状況**:
  - 日付形式が不正。
  - 数値フィールドに文字列が含まれている。

#### 3. レコードキーエラー
- **説明**: レコードの検索や更新で指定されたキーが存在しない場合に発生します。
- **例外状況**:
  - ファイル内に該当するレコードが見つからない。

#### 4. 論理エラー
- **説明**: プログラムの処理において、意図しない動作が発生するようなエラーです。
- **例外状況**:
  - 条件分岐が正しく機能しない。
  - 無限ループに陥る。

### エラーハンドリングの実装方針

#### エラーハンドリング戦略
- **監視とログ記録**: 発生したエラーの詳細をログファイルに記録します。これにより、エラーの原因分析が容易になります。
- **ユーザー通知**: ユーザーにはエラー発生時に適切なメッセージを表示し、システムの使用を継続するためのガイダンスを提供します。
- **ロールバック**: 重要な処理においてエラーが発生した場合、データの整合性を保つために処理をロールバックします。

#### コードにおける具体的なエラーハンドリング例
以下に、特定のソースコード内での実際のエラーハンドリングの方法を示します。

##### ファイルアクセスエラーの処理
`H_setant.cbl`内のファイルアクセス時には、ファイルステータスをチェックし、エラーが発生した場合にはエラーメッセージを出力するコードが必要です。

```cobol
IF FILE-STATUS NOT = '00'
    DISPLAY "ファイルアクセスエラーが発生しました。"
ENDIF
```

##### データフォーマットエラーのチェック
`Reigai06.cbl`では、データの読み込み後、フィールドのフォーマットを確認し、不正なデータがあればエラーメッセージを表示します。

```cobol
IF NOT IS-VALID-DATA(DATA-FIELD)
    DISPLAY "データフォーマットエラー：不正なデータが含まれています。"
ENDIF
```

##### レコードキー検査
`H_noyote.cbl`のレコード処理部分では、キーを基にした検索結果を確認し、見つからなかった場合にはエラーを処理します。

```cobol
IF RECORD-FOUND = FALSE
    DISPLAY "レコードが見つかりませんでした。"
ENDIF
```

### ガイドライン

1. エラー発生の可能性を事前に考慮すること。
2. 所属するプログラム内で一貫したエラーハンドリング方法を採用すること。
3. ユーザー向けメッセージは明確で分かりやすくすること。
4. エラーログは定期的に確認し、問題の根本原因を追跡すること。

このガイドラインに従い、システム全体のエラーハンドリングを強化し、可用性と信頼性を向上させることを目指します。

## 6. セキュリティ設計


このセクションでは、システム内のデータセキュリティとユーザーアクセス管理について説明します。特に個人情報や機密データに関して、実装されるセキュリティ対策に焦点を当てています。

### 1. データセキュリティ

システムで管理されるデータは、個人情報や機密情報を多く含んでいます。そのため、以下のセキュリティ対策が実施されています。

#### 1.1 データ暗号化

- 保存される個人情報や機密情報は、暗号化アルゴリズム（具体的なアルゴリズム名は非表示）を使用して暗号化されます。これにより、データが不正アクセスによって取得された場合でも、情報の内容が露呈することを防ぎます。

#### 1.2 アクセス制御機能

- ユーザーごとに異なるアクセス権限が設定されており、データの読み取り・編集・削除の権限が管理されています。特に、個人情報や保険者情報に関しては、限られた権限を持つユーザーのみがアクセスできるようになっています。

#### 1.3 ログ管理

- システム内でのすべてのデータアクセスはログに記録され、定期的に監査されます。この監査ログは、不正アクセスの追跡やセキュリティインシデントの分析に利用されます。

### 2. ユーザーアクセス管理

ユーザーアクセス管理は、データセキュリティにおける重要な要素であり、以下のような実装がされています。

#### 2.1 認証機能

- ユーザーは、システムにアクセスする際に、ユーザー名とパスワードを用いて認証を受ける必要があります。パスワードは、一定の複雑性要件を満たす必要があり、定期的に更新することが推奨されます。

#### 2.2 権限管理

- ユーザーは役職や業務に応じた権限が付与され、必要なデータにのみアクセスできるよう管理されています。この権限は、業務ニーズの変更に応じて定期的に見直されます。

#### 2.3 セッション管理

- ユーザーのセッションは、一定時間無操作だった場合には自動的にログアウトされるようになっており、これにより不正利用のリスクを軽減します。

### 3. 機密データに関する特別な対策

- 特にセンシティブな情報（例: 保険者番号や施術者信情報など）に対しては、より厳重なアクセス制御と監査が行われます。これらの情報は、暗号化による保護の他、アクセス先のIPアドレス制限や、特定のデバイスからのみのアクセスを許可するなどの追加的なセキュリティ対策が施されています。

以上のセキュリティ対策を通じて、システムは保護されており、ユーザー及びデータの安全性が確保されています。

## 7. システムテスト


このセクションでは、システム全体のテスト計画、テストケース、および期待される結果を整理します。テストは、機能検証やデータの整合性を確保するための重要なプロセスであり、以下のように分類されるテストを実施します。

### 7.1 テストの種類

#### 7.1.1 単体テスト
- **目的**: 各個々のモジュールやコンポーネントが正常に動作するかを確認します。
- **テストケース**:
  1. `KAIKEI.CBL`: KAIKEI.DATファイルを正しく読み込み、レコードの入出力を行うか確認。
  2. `HUGEIN2.CBL`: データ構造 `儗僐乕僪` の各フィールドが適切に初期化および処理されるか検証。
  3. `Seigyo01.cbl`: 各設定項目が正常に処理され、期待した結果を返すか確認します。

#### 7.1.2 結合テスト
- **目的**: 組み合わされた複数のモジュールが相互に連携して正常に動作することを確認します。
- **テストケース**:
  1. `KAIKEI.CBL` と `HUGEIN2.CBL` の連携をテストし、会計データが正しく反映されるか確認。
  2. `Seigyo01.cbl` と `H_seigyo.cbl` の間でデータがどのように流れるかをテストし、メモパスワードや制御区分が適切に転送されるかを確認。

#### 7.1.3 システムテスト
- **目的**: システム全体が要件を満たすことを確認します。
- **テストケース**:
  1. 入力データに基づいて、一括集計処理を実行し、期待される結果（会計報告書や請求書）が出力されるか確認。
  2. エッジケース（不正なデータや空のデータ）を用いて、システムが適切にエラーハンドリングを行うかをテストします。
  3. ユーザーインターフェース上の入力項目に不正な値を入力し、システムが適切にエラーを通知するかを確認します。

### 7.2 テストケースの詳細

| テストケースID | テスト対象ファイル | 説明                                      | 入力データ           | 期待される結果                                                |
|----------------|---------------------|-----------------------------------------|----------------------|-------------------------------------------------------------|
| TC001          | KAIKEI.CBL         | データファイルの読み込みを確認            | KAIKEI.DAT（正常データ） | 正常にレコードが読み込まれ、データが正しく処理されること   |
| TC002          | HUGEIN2.CBL        | データ構造の初期化の確認                | 正常なデータ          | 各フィールドが正しく初期化されていること                   |
| TC003          | Seigyo01.cbl       | 設定項目の正しい処理を確認              | 各種印刷区分の設定     | 期待した印刷設定の結果が出力されること                     |
| TC004          | H_seigyo.cbl       | 機能間連携の確認                         | 各種設定               | 施術証明書や領収書が正しい情報で生成されること            |
| TC005          | 全ファイル          | システム全体の整合性を確認              | 不正データ              | エラー通知が行われ、全体の処理が止まること                |
| TC006          | ユーザーインタフェース | 入力検証機能の確認                      | 不正な文字列           | エラーメッセージが表示され、入力が拒否されること          |

### 7.3 期待される結果

各テストケースにおいて、正しい実装が行われていれば期待される結果は以下の通りです。

- 単体テストでは、各機能が期待される出力を正しく生成すること。
- 結合テストでは、モジュール間のデータの流れに問題がなく、一貫した動作をすること。
- システムテストでは、全体としての業務要件を満たし、収集したデータに基づく正しい情報が出力されること。

以上を踏まえ、システムテストを通じて各コンポーネントやシステム全体が高い品質を持つことを保証します。

## 8. デプロイメント手順


本セクションでは、本番環境へのデプロイ手順を整理し、実行環境や設定項目を明確にします。具体的な設定ファイルや依存関係の取り扱いについても説明します。

### 実行環境

1. **プラットフォーム**：
   - 本プログラムは、NetCOBOLによって開発されており、適切な動作を保障するためには、NetCOBOLランタイム環境が必要です。

2. **サーバ要件**：
   - 必要なリソース（CPU、メモリ、ストレージ）については、実際のデータ量およびアクセス頻度に基づいて検討する必要があります。

3. **データベース**：
   - 本プログラムで扱うファイルは、各種マスタデータとなっており、これを参照するためのデータベースが必要です。具体的なデータベース管理システム（DBMS）は明示されていませんが、テキストファイル（.DATファイル）を通じて動的にアクセスされます。

### 設定項目

1. **ファイル位置**：
   - 各マスタデータファイル（例：`UKEITEML`, `sisetu.dat`, `SEIHOJ.DAT`）は、所定のディレクトリに配置する必要があります。一般的には、アプリケーションの実行ディレクトリ内または特定のデータフォルダに配置します。

2. **環境変数**：
   - NetCOBOLの実行に必要な環境変数が設定されていることを確認します。特に、ライブラリパスやデータファイルのパスを正しく設定することが重要です。

### デプロイ手順

1. **ファイルの配置**：
   - ソースコードから生成されたバイナリファイルをデプロイ先環境に配置します。
   - 各マスタデータファイルも適切なパスに配置してください。

2. **テスト実施**：
   - デプロイ後、初期テストを実施します。これには以下が含まれます：
     - 各データファイルへのアクセスが正しく行えるか確認。
     - プログラムの主要機能が期待通りに動作するかの確認。

3. **アクセス権の設定**：
   - ファイルおよびディレクトリのアクセス権が適切に設定されているか確認します。必要に応じて、リード、ライトの権限を設定します。

4. **運用監視**：
   - デプロイ後も、プログラムの動作やエラーログを定期的にモニタリングし、必要な調整や設定変更を行います。

### 依存関係

- 本プログラムは、特定のデータファイルに依存しているため、これらのファイルが常に利用可能であることが重要です。
- また、開発環境と本番環境でのバージョンが一致していることを確認することもデプロイの成功に寄与します。

これらの手順に従い、適切にアプリケーションをデプロイすることで、安定した稼働環境を確保することができます。

## 9. 運用・保守ガイドライン


このガイドラインでは、システムの運用および保守に必要な手順をまとめています。データバックアップや障害対応の具体的なフローに関して詳述します。

### 9.1 データバックアップ手順

1. **定期バックアップのスケジュール設定**
   - バックアップは毎日、週末、月末に実施することを推奨します。
   - バックアップの実施時間を業務に影響がない時間帯に設定します。

2. **バックアップ対象の特定**
   - 施術者マスタ（H施術者マスタ）
   - 摘要ファイル（TEKIYO）
   - メモファイル（MEMO）

3. **バックアップ方法**
   - 各ファイルを指定したバックアップストレージにコピーします。
   - 使用するコマンドやツール（例：rsync, tar）は、システムに応じて選定してください。

4. **バックアップの確認とのログ記録**
   - バックアップ後、正常に完了したか確認します。
   - 確認結果をログファイルに記録し、定期的にログを確認します。

5. **バックアップの保存期間**
   - バックアップは最低1ヶ月間保存し、古いバックアップから順に削除します。

### 9.2 障害対応手順

1. **障害の検知**
   - システムのモニタリングツールを使用し、異常を早期に検知します。
   - 障害発生時は、アラートが関連部署に通知されるよう設定します。

2. **初期障害対応**
   - 障害が発生した場合、最初にシステムのログファイルを確認します。
   - 障害の内容を特定し、影響を受けるサービスを確認します。

3. **影響範囲の評価**
   - 障害が業務に与える影響を評価し、優先度を設定します。
   - 施術者情報や患者データの損失を防ぐための対策を講じます。

4. **復旧フロー**
   - データバックアップからの復元を行います。
   - システムを正常な状態に戻すため、必要な修正を実施後、サービスを再起動します。

5. **障害後のレビュー**
   - 障害が解決した後、対応プロセスをレビューし、発生原因を分析します。
   - 障害の再発を防ぐための改善策を策定し、実施します。

### 9.3 システムの定期保守

1. **定期点検のスケジュール設定**
   - システム全体の点検を、四半期ごとに実施することを推奨します。

2. **点検内容**
   - セキュリティパッチの適用状況の確認。
   - データベースの最適化や不要データのクリーニング。
   - システムパフォーマンスのレビュー。

3. **問題発見時の対応**
   - 問題が見つかった場合は、即時に関連する文書や手順に従って修正作業を行います。
   - 修正後は再確認を行い、各種ログを更新します。

これにより、システムの可用性と信頼性を維持し、業務に対する影響を最小限に抑えることができます。

