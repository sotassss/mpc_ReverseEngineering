# コードサンプルPython仕様書

## 目次
1. [はじめに](#1-はじめに)
2. [システム概要](#2-システム概要)
3. [ファイル構成](#3-ファイル構成)
4. [設定ファイル](#4-設定ファイル)
5. [Pythonスクリプトの概要](#5-pythonスクリプトの概要)
6. [センシティブファイルの取り扱い](#6-センシティブファイルの取り扱い)
7. [OCR処理の流れ](#7-ocr処理の流れ)
8. [テストと検証の方法](#8-テストと検証の方法)
9. [結論](#9-結論)

---

## 1. はじめに


本書は、特定のプログラムに関する仕様書であり、プログラムの概要、機能、および構成要素について説明します。本ドキュメントの目的は、ソフトウェア開発チーム、維持管理者、テスト担当者、および利用者に対して、このプログラムがどのように機能するかを明示し、利用および保守に必要な情報を提供することです。

本書は、特定の背景や目的のために作成されており、特にセンシティブなデータを処理するソフトウェアについての情報が含まれています。このため、一部の内容は安全上の理由から非表示とされています。プログラムは、画像からの情報抽出を行うためのOCR（光学文字認識）処理を中心に構築されており、具体的には請求書や領収書などの情報を自動的に取得し、整理することを目的としています。

文書は、各モジュールおよび処理の役割、連携の方法について詳述しており、読者がこのプログラムを理解し、効果的に利用できるように構成されています。主な対象読者は、開発チーム、技術的なサポートを必要とするユーザー、プログラムのメンテナンスを担当するエンジニアたちです。

各セクションでは、プログラムの詳細や機能を具体的に明記しており、利用にあたっての注意点や設定ファイルの内容に関する情報も提供します。ただし、センシティブな内容に関しては、必要な情報を保護するために非表示とし、詳細な説明は控えます。このドキュメントが、関与するすべての要素において有用な参考外になることを期待しています。

## 2. システム概要


本システムは、OCR（光学文字認識）処理を中核に据え、請求書や領収書といったスキャン画像から情報を抽出し、Excelファイルに整理して出力する機能を提供します。ユーザーは、スキャンデータをデジタル化し、手動でのデータ入力を削減することで、業務効率を大幅に改善することができます。

### システムの主な機能

1. **OCR処理の実施**:
   各画像に対し、OCRを適用して文字情報を抽出し、後続の処理に必要なデータを生成します。これにより、請求書や領収書の内容を自動的にデジタルフォームに変換することが可能になります。

2. **画像処理**:
   画像の向きや状態を整えるための複数の前処理ステップが実施されます。横向きの画像を90度回転させ、さらに画像を水平に整える処理を行うことで、OCRの精度を向上させるための環境を整えます。

3. **情報の抽出と整理**:
   抽出された情報から、特定のキーワード（項目名、単価、数量、金額など）を認識し、必要なデータを効率的に見つけ出すためのプロセスを実装しています。

4. **データ出力**:
   通常のExcelファイルとしてまとめられたデータは、後続の業務フローで活用しやすい形で出力されます。重複データの統合処理により、一貫性のあるデータセットが生成され、業務の正確性を確保します。

5. **Azure Document Intelligenceの活用**:
   請求書の基本情報を認識するためにAzureのDocument Intelligenceを使用することで、高精度な情報抽出を実現し、スキャン画像から得られたデータの品質を向上させます。

### 業務への寄与

このシステムは、請求書や領収書のデジタル化を通じて、業務プロセスの効率化、エラーの削減、コストの低減を図ることを目的としています。手動でのデータ入力を減少させ、迅速な情報処理を可能にすることで、ユーザーは貴重な時間とリソースを他の重要な業務に集中させることができます。また、出力されたデータは分析や報告業務に即座に活用でき、意思決定プロセスの迅速化にも寄与します。

全体として、システムは情報処理のフローを自動化し、ビジネスのデジタル転換を支援するために設計されています。ユーザーは、スキャン画像から抽出されたデータを簡単に活用し、ビジネスの生産性を向上させることが期待されます。

## 3. ファイル構成


このセクションでは、システムに含まれる各ファイルの一覧とその役割について詳しく説明します。特にセンシティブなファイルについての取り扱いと考慮点も明示します。

### 1. センシティブファイル

#### パス: code/code_sample_python\sample.pfx
- **役割**: このファイルはセンシティブな内容が含まれているため、内容の確認や具体的な説明はできません。このためリスクを避けるために、アクセスや取り扱いには慎重を期する必要があります。

#### パス: code/code_sample_python\LargeFile.py
- **役割**: このファイルもセンシティブなデータを扱う可能性がありますが、具体的な内容は非表示であるため、詳細は記述できません。通常、このようなファイルではデータ分析やセキュリティ関連の処理、あるいはユーザー情報の管理が行われることが考えられます。

### 2. 設定ファイル

#### パス: code/code_sample_python\config.yml
- **役割**: YAML形式で記述された設定ファイルです。YAMLファイルは、システムやアプリケーションの設定やオプションを、人間が読みやすい形で保存するために使用されます。このファイルは、階層構造を持つデータ表現が可能であり、設定項目とその値を親子関係で整理して記述します。具体的な設定内容は非表示ですが、全体の動作に影響を与える重要な役割を担っています。

### 3. OCR関連のスクリプト

#### パス: code/code_sample_python\LargeFile.py
- **役割**: 請求書や領収書のスキャン画像から情報を抽出し、Excelファイルに整理して出力するための処理を構成しています。このファイルには以下のスクリプトが含まれています。

1. **1_ocr_only.py**
   - 指定されたフォルダ内のPNGファイルに対してOCRを実行し、抽出した文字情報を別のフォルダに保存します。画像内のテキストを読み取るが、結果を視覚的に表示はしません。

2. **2_change_direction.py**
   - 画像の向きを統一するため、横向きの画像を90度回転させます。OCRで認識されたテキストの位置情報を元に、画像の正しい向きを判断します。

3. **3_make_flat.py**
   - 画像を水平にする処理を行い、最終的に読みやすくするための修正を追加します。

4. **4_ocr_all.py**
   - 水平に整えた画像に対して再度OCRを実行し、抽出したテキスト情報を含む画像を生成します。この段階では認識結果やバウンディングボックスが可視化されます。

5. **5_search_all.py**
   - 抽出された情報から特定のキーワード（項目名、単価、数量、金額）を探し、結果を端末に表示します。

6. **6_write_excel.py**
   - 抽出した情報をExcelファイルにまとめて出力します。

7. **7_document_intelligence.py**
   - AzureのDocument Intelligenceを利用して、請求書の基本情報を認識し、新しいExcelファイルに保存します。

8. **8_1_search_base_ocr.py** から **9_connect_base.py**
   - 複数の情報源から得られた結果を統合し、最終的な出力を生成します。

9. **10_1_merge_excel.py** と **10_2_merge_excel.py**
   - 複数のExcelファイルから重複するデータを統合し、一貫した出力を生成します。

10. **11_merge_excel.py**
    - 最終的な請求書情報をまとめ、統合した結果から出力ファイルを生成します。

### 4. 注意事項

センシティブファイルに関しては、情報漏洩を防ぐために適切なアクセス制限や暗号化等の対策を講じる必要があります。また、YAML設定ファイルの編集にあたっては、構文エラーを避けるために注意が必要です。

## 4. 設定ファイル


`config.yml` は、YAML形式で記述された設定ファイルであり、システムの動作を構成するための各種オプションが含まれています。このファイルは人間が読みやすい形で設定情報を整理することができ、階層構造を利用して親子関係のあるデータを表現しています。

### 設定項目一覧

以下は、`config.yml` に含まれる具体的な設定項目の概要です。具体的な内容は非表示ですが、各項目の意味や可能な設定値について概説します。

#### 1. ホスト設定 (`host`)
- **意味**: システムがアクセスするホスト名またはIPアドレスを指定します。
- **推奨値**: 一般的にはローカル開発環境であれば `localhost`、本番環境であれば実際のIPアドレスやドメイン名を設定します。

#### 2. ポート番号 (`port`)
- **意味**: サーバーがリッスンするポート番号を指定します。
- **推奨値**: 通常、HTTPであれば80、HTTPSであれば443、開発環境では8080などが推奨されます。

#### 3. データベース設定 (`database`)
- **意味**: 接続するデータベースの情報を定義します。
- **推奨値**: 使用するデータベースの種類（例: MySQL, PostgreSQL）に応じて適宜設定し、接続文字列のフォーマットを遵守します。

#### 4. APIキー (`api_key`)
- **意味**: 外部サービスと接続するために必要なAPIキーを保持します。
- **推奨値**: セキュリティの観点から、この値は一意で秘密にすることが重要です。

#### 5. ログレベル (`log_level`)
- **意味**: システムのログ出力の詳細度を設定します。
- **推奨値**: `DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL` のいずれかを選び、開発環境では `DEBUG` など詳細な情報を記録し、本番環境では通常 `ERROR` などに設定するのが望ましいです。

### システム実行への影響

- **ホストとポート設定**: 正しい設定がなされていない場合、システムに対するリクエストが失敗し、機能しなくなる可能性があります。
- **データベース設定**: データベース接続が不適切な場合、データの取得や保存ができず、システム全体が正常に機能しなくなります。
- **APIキー**: 不正確または漏洩したAPIキーは、外部サービスに接続できない原因となりうるため、適切に管理する必要があります。
- **ログレベル**: ロギングの詳細度が適切でない場合、デバッグに必要な情報が欠如したり、逆に大量の無駄なログが生成されたりすることがあります。

これらの設定項目を適切に設定することは、システムの安定性やパフォーマンスに直結するため、十分な注意が必要です。

## 5. Pythonスクリプトの概要


このセクションでは、各Pythonスクリプトの目的と機能について簡潔に説明します。特に、`sample1.py`、`sample2.py`、`sample3.py`については、それぞれの処理の流れや連携を記載します。

### sample1.py

`sample1.py`は、二つの数値を受け取り、加算を行う関数`add`を定義しています。この関数は、引数として与えられた二つの数値を足し合わせ、その結果を返します。このスクリプトは、他のスクリプトからインポートされ、数値計算の基盤となる役割を果たします。

### sample2.py

`sample2.py`は、二つの数値を受け取り、乗算を実行する関数`multiply`を定義しています。この関数は、引数として与えられた数値を掛け算し、その成果を返します。このスクリプトもまた、他のスクリプトから利用されることを目的としています。

### sample3.py

`sample3.py`は、`sample1`と`sample2`の両モジュールから関数をインポートし、具体的な数値計算を実施します。具体的な処理は以下の通りです：

1. 変数`x`と`y`がそれぞれ5と3に設定されます。
2. `sample1`からインポートした`add`関数を使用して、`x`と`y`の和を計算します。
3. `sample2`からインポートした`multiply`関数を使用して、`x`と`y`の積を計算します。
4. 計算結果が"和:"および"積:"というプレフィックスと共に出力されます。

このように、`sample3.py`は`sample1.py`と`sample2.py`の機能を組み合わせて、加算と乗算の計算結果を表示する役割を持っています。各スクリプトは明確に役割を分担し、互いに連携することで、全体としての計算処理を完結しています。

## 6. センシティブファイルの取り扱い


センシティブなファイルの取り扱いには厳格なガイドラインが必要です。このセクションでは、特に`LargeFile.py`や`sample.pfx`などのセンシティブなファイルに関連する注意点、リスク、セキュリティの原則について明示します。

### 注意点

1. **アクセス制限**:
   - センシティブなファイルへのアクセスは、必要な権限を持つユーザーのみに制限するべきです。適切な認証・認可手段を用いることが推奨されます。

2. **データ暗号化**:
   - 保存時および転送時にはデータを暗号化し、第三者からの不正アクセスを防ぐ必要があります。

3. **バックアップとリカバリ**:
   - 定期的なバックアップを実施し、データ損失に備えたリカバリ手順を策定します。バックアップデータも同様に保護することが重要です。

4. **ログ管理**:
   - センシティブファイルへのアクセスや変更に関するログを記録し、適切に監視することで不正利用を早期に検出できる体制を整えます。

### リスク

1. **情報漏洩**:
   - 不正アクセスや従業員のミスにより、センシティブな情報が外部に漏洩するリスクがあります。

2. **データ損失**:
   - デバイスの故障、自然災害、サイバー攻撃によるデータ損失の可能性があるため、常にリスクを想定した対策が必要です。

3. **法的リスク**:
   - センシティブ情報の管理に関しては、個人情報保護法などの法律に抵触する可能性があるため、法的な遵守が求められます。

### セキュリティの原則

1. **最小権限の原則**:
   - ユーザーやプロセスには、業務を遂行する上で最小限の権限のみを付与します。

2. **定期的なセキュリティレビュー**:
   - 定期的にセキュリティポリシーや手順を見直し、必要に応じて更新します。

3. **教育と訓練**:
   - 従業員や関係者に対して、センシティブなデータの取り扱いに関する教育を行い、リスク意識を高めます。

4. **セキュリティツールの活用**:
   - ウィルス対策ソフトウェア、ファイアウォール、侵入検知システムなど、様々なセキュリティツールを用いて防御を強化します。

全ての取り扱いステップにおいて、以上の注意点やリスク管理、セキュリティの原則を遵守することで、センシティブなファイルの安全性を確保します。

## 7. OCR処理の流れ


OCR（光学文字認識）処理の流れは、請求書や領収書などのスキャン画像から情報を抽出し、整理された形式で出力するための一連の手順で構成されています。以下に、各ステップを詳細に説明します。

1. **画像の取得**  
   スクリプト `1_ocr_only.py` は、指定されたフォルダ内のPNGファイルに対してOCRを実行します。これにより、画像内のテキスト情報が抽出され、別のフォルダに保存されます。

2. **画像の向きの調整**  
   スクリプト `2_change_direction.py` は、OCRで認識されたテキストの位置情報に基づいて、横向きの画像を90度回転させます。これにより、すべての画像が正しい向きを保つことができます。

3. **画像の水平化**  
   スクリプト `3_make_flat.py` では、画像をさらに水平にする処理が行われます。この処理は、OCR認識精度を向上させ、抽出されるテキストが読みやすくなるように補正します。

4. **OCRの実行**  
   水平に整えた画像に対して再度OCRを実行するのが、スクリプト `4_ocr_all.py` の役割です。この処理によって、画像内のテキスト情報を抽出し、その認識結果やバウンディングボックスが可視化された画像が生成されます。

5. **情報の検索**  
   スクリプト `5_search_all.py` では、抽出された情報から特定のキーワード（項目名、単価、数量、金額など）を探し出し、それを端末に表示します。この処理により、必要なデータを迅速に把握できます。

6. **Excelファイルへの出力**  
   スクリプト `6_write_excel.py` は、抽出した情報を整理し、Excelファイルに出力します。これにより、データを表形式で管理しやすくなります。

7. **Document Intelligenceの活用**  
   スクリプト `7_document_intelligence.py` では、AzureのDocument Intelligenceを利用して、請求書の基本情報を自動認識し、解析結果を新たなExcelファイルに保存します。

8. **情報の統合**  
   スクリプト群 `8_1_search_base_ocr.py` から `9_connect_base.py` は、OCR結果やその他の情報源から得られた結果を統合し、最終的な出力を生成します。

9. **Excelファイルのマージ**  
   スクリプト `10_1_merge_excel.py` と `10_2_merge_excel.py` は、複数のExcelファイルから重複データを統合し、一貫した出力を生成するための処理を行います。

10. **最終出力の生成**  
    最後に、スクリプト `11_merge_excel.py` によって、最終的な請求書情報がまとめられ、統合結果から出力ファイルが生成されます。

このように、全体の流れは画像の処理から始まり、情報の抽出と整理、最終的なデータの出力に至るまで、各スクリプトが連携して機能し、OCR処理のフローを形成しています。

## 8. テストと検証の方法


このセクションでは、システムのテスト方法や検証手順について具体的に説明します。また、期待される結果や実際のテストケースについて情報を整理します。

### テスト方法

システムは以下の手法を用いてテストされます。

1. **ユニットテスト**:
   - 各スクリプトに対してユニットテストを実施し、個々の関数やメソッドが期待通りに動作するかを確認します。
   - Pythonの`unittest`フレームワークを使用して, 各機能に対するテストケースを作成します。

2. **統合テスト**:
   - スクリプト間の統合を確認するために、全体のフローを通じてデータが正しく受け渡されるかをテストします。
   - 各ステップの出力が次のステップの入力として正しく機能するかを検証します。

3. **システムテスト**:
   - 完成したシステム全体を対象に外部からのインプットを用いてテストを行います。
   - 実際のスキャンした請求書や領収書画像を用いて、エンドツーエンドのプロセスが正常に動作するかを確認します。

4. **受け入れテスト**:
   - エンドユーザーによるテストを実施し、要求仕様に沿った動作をしているかを確認します。

### 検証手順

1. **入力データの準備**:
   - テスト用の画像ファイルを用意し、様々なフォーマットや品質の請求書や領収書を含む。
   - この画像は、異なる解像度や異なる方向に配置された場合のシナリオも考慮します。

2. **テストの実施**:
   - 各スクリプトを単独で実行し、出力結果が期待される形式で生成されるかを確認します。
   - 統合テストを実施し、出力が一貫していることを確認します。

3. **結果の検証**:
   - 出力されたデータの正確性を確認するため、手動で抽出されたデータと自動化されたデータを比較します。
   - エラーが発生した場合、どの部分で問題が生じたかを特定し、デバッグを行います。

### 期待される結果

- OCR処理が正確にテキストを抽出し、適切にフォーマットされたデータが生成されること。
- Excelファイルに出力されるデータが正確であり、重複が排除されていること。
- 各スクリプトの処理時間が許容範囲内であること。
- 最終的な出力ファイルが正しいフォーマットで保存され、必要な情報が全て含まれていること。

### テストケースの例

- **テストケース1**: `1_ocr_only.py`によるOCR結果の確認
  - **入力**: 請求書画像 (例：sample_invoice.png)
  - **期待される出力**: OCRによって抽出されたテキストファイル (例：output_text.txt)

- **テストケース2**: `5_search_all.py`によるキーワード検索
  - **入力**: 抽出されたテキスト
  - **期待される出力**: 特定キーワードのリスト (例：単価、数量、金額が含まれていること)

- **テストケース3**: `6_write_excel.py`によるExcel出力
  - **入力**: 抽出情報
  - **期待される出力**: フォーマットされたExcelファイル (例：output_data.xlsx)

これらの手順およびテストケースを通じて、システムが意図した通りに機能するかを徹底的に検証していきます。

## 9. 結論


本書では、画像処理およびデータ抽出のプロセスに関する一連のソースコードを詳細に説明しました。特に、OCR処理に関しては、複数のPythonスクリプトが互いに連携し、スキャン画像からのテキスト情報の抽出、整理、Excelファイルへの出力に至るまでの流れを包括的にカバーしています。各スクリプトは特定の役割を持ち、その機能を通じて全体として効率的なデータ処理を実現しています。

次のステップとしては、以下の提案を検討することが考えられます：

1. **コードレビューと最適化**: 各スクリプトの性能や可読性を向上させるために、チーム内でコードレビューを実施し、改善点を洗い出す。

2. **テストとデバッグ**: OCR結果の精度を確認し、不具合を特定するために、ユニットテストや統合テストを実施し、必要に応じてデバッグを行う。

3. **ドキュメンテーションの充実**: 各スクリプトの機能や使用方法についてのドキュメントを整備し、新たな開発者が容易に理解できるようにする。

4. **データのセキュリティ強化**: センシティブなデータを扱うため、データの暗号化や不正アクセス防止の手法を取り入れ、セキュリティを強化する。

5. **ユーザインターフェースの検討**: プロセスを自動化するためのユーザインターフェースの開発を検討し、エンドユーザーが操作しやすい環境を提供する。 

これらのステップにより、プロジェクトの成果をさらに向上させることが期待されます。

