# COBOLプログラム仕様書

## 目次
1. [はじめに](#1-はじめに)
2. [システム概要](#2-システム概要)
3. [データ構造とエンティティ](#3-データ構造とエンティティ)
4. [ファイル構成](#4-ファイル構成)
5. [開発環境](#5-開発環境)
6. [エラーハンドリングとデバッグ](#6-エラーハンドリングとデバッグ)
7. [ユーザーガイド](#7-ユーザーガイド)
8. [セキュリティ設計](#8-セキュリティ設計)
9. [メンテナンスと更新方針](#9-メンテナンスと更新方針)

---

## 1. はじめに


本ドキュメントは、特定のCOBOLプログラムに関する仕様書です。これには、プログラムの目的、範囲、および使用対象者が明示されます。また、各プログラムが解決するビジネスニーズを要約し、全体の文脈を提供します。

### 目的

本ドキュメントの主な目的は、プログラムの設計、使用方法および今後の保守・拡張のためのガイドラインを提供することです。特に、COBOLプログラムがそのビジネスニーズにどのように貢献しているかを理解することが目標です。

### 範囲

このドキュメントは、以下の3つのCOBOLプログラムを対象としています。

- `BARCNT.CBL`
- `Seigyo02.cbl`
- `KEISANA.CBL`

また、関連するファイルやスニペットについても言及し、全体のシステムの中での位置づけを示します。

### 使用対象者

この文書は、以下の関係者を対象としています。

- 開発者: プログラムの保守や拡張を行うエンジニア。
- プロジェクトマネージャー: プログラムの進行状況や必要な機能に関しての管理を行う担当者。
- テストエンジニア: ソフトウェアがビジネスニーズを満たしているかどうかの検証を行うテスト担当者。
- ビジネスアナリスト: プログラムが解決するビジネスニーズを理解し、業務改善の提案を行う担当者。

### ビジネスニーズ

本プログラム群は、特定の業務プロセスを効果的に支援するために設計されています。具体的には、データ処理やデータベースとのインターフェース、ファイル操作などの業務ロジックを処理することによって、次のようなビジネスニーズに応えます。

- 正確で効率的なデータ処理の実施
- ユーザーインターフェースとの連携による操作性の向上
- 複雑な業務ロジックの簡易化

以上を通じて、組織全体の業務効率を向上させ、意思決定に必要な情報をタイムリーに提供することが本プログラムの目的です。

## 2. システム概要


本システムは、データ処理と管理を目的として設計されています。主にCOBOLとPythonで構成されており、異なるプログラミング言語がそれぞれ特定の役割を果たすことで、全体の機能を実現しています。

### システムアーキテクチャ

システムのアーキテクチャは以下のように構成されています。

1. **データ構造の定義** 
   - COBOLプログラム（例：`LABEL.CBL`, `RYOUKNF.CBL`）は、業務に関連するデータ構造を定義します。これにより、プログラム内で使用されるデータが整理され、データ処理が容易になります。
   - 各プログラムには、項目、グループ項目、ネストした項目などが含まれており、構造的に管理されています。

2. **データ処理**
   - Pythonプログラム（例：`sample.pfx`）は、データの取得、加工、出力に関連する処理を担当します。
   - 具体的な操作には、データの計算や整形、ビジネスロジックの実行が含まれます。

### 主要なモジュールと相互作用

下記はシステム内の主要なモジュールとその相互作用を示した構成図です。

```
+-------------------+
|   Python Module   |
|    (sample.pfx)  |
+-------------------+
          |
          v
+-------------------+
|   COBOL Module    |
|    (LABEL.CBL)   |
+-------------------+
          |
          v
+-------------------+
|   COBOL Module    |
|    (RYOUKNF.CBL)  |
+-------------------+
```

- **Python Module**: 
  - `sample.pfx` では、データを取得し、処理を行い、その結果を他のモジュール（COBOL）に渡します。関数はデータ操作の中心であり、変数は処理の状態を保持します。

- **COBOL Modules**:
  - `LABEL.CBL` と `RYOUKNF.CBL` はデータの定義と、それを基にした処理を行います。これにより、データの整合性が保たれつつ、必要な情報を効果的に利用できます。

このシステムは、データの取得から処理、出力までの全体的な流れを効率的に管理するために、各モジュールが効果的に相互作用しています。全体として、業務の要件を満たすために設計されていることが伺えます。

## 3. データ構造とエンティティ


このセクションでは、指定されたソースコードから特定された主要なデータ構造とそれに関連するエンティティを定義し、それぞれの役割と相互関係を簡潔に説明します。

### データ構造一覧

| データ構造名       | 説明                                                                                 | 主要フィールド                                    |
|------------------|-------------------------------------------------------------------------------------|------------------------------------------|
| 儗僐乕僪            | プログラムのメインデータ構造。主にサブアイテムを含む。                                           | 儗僐乕僪僉乕、儗僐乕僪僨乕僞                        |
| 儗僐乕僪僉乕        | メインデータ構造内のサブ項目。情報を格納するためのフィールドを含む。                                      | 儔儀儖斣崋、儔儀儖僇僫、FILLER                 |
| 儔儀儖斣崋         | データエントリ用のフィールド集合。各種の型を持つサブ項目を含む。                                           | 儔儀儖斣崋侾、儔儀儖斣崋俀                           |
| 儔儀儖僇僫         | 別のサブデータ構造。複数の文字列フィールドを持つ。                                                       | 儔儀儖僇僫、儔儀儖柤徧、FILLER                      |
| 揹榖斣崋           | 文字列データを格納する変数。特定の用途に使用される。                                                    | -                                        |
| FILLER            | 余分なスペースを埋めるためのプレースホルダー。                                                           | -                                        |
| 掽尭棪             | 繰り返し可能なデータ構造。データの配列を格納する。                                                       | 長さや型に関して具体的な詳細は確認できず。                |
| 奐巒榓楋擭寧        | 数値データを格納するためのサブデータ項目。                                                              | 奐巒榓楋、奐巒擭寧、FILLER                      |
| 条件付き統計指標    | 統計データとそれに関連するフラグを設定するためのエンティティ。                                           | 見出しに関する詳細は不足しているため、非表示。             |

### 各エンティティの詳細

1. **儗僐乕僪**
   - 最上位データ構造で、他のサブデータ構造を内包します。
   
2. **儗僐乕僪僉乕**
   - サブフィールドを持つデータ項目で、情報を蓄積する役割を持つ。

3. **儔儀儖斣崋**
   - 特定のデータフィールドが含まれ、入力されたデータを格納します。

4. **FILLER**
   - データ構造の余白を埋めるために存在し、プログラムの動作に直接的な影響はありません。

5. **掽尭棪**
   - 繰り返しを持つデータ項目で、一定数のデータの集約を目的とします。

6. **奐巒榓楋擭寧**
   - 数値を格納するための項目で、他の数値データと組み合わせた複雑な構造を形成します。

このデータ構造は、複数のエンティティが連携し合うことにより、プログラム全体のデータの収集と処理を可能にする重要な要素を提供します。具体的なデータの用途は、コーディングの他の部分を分析することで明らかになるでしょう。

## 4. ファイル構成


以下は、各COBOLプログラムファイルの名称、内容概要、役割、および関連する機能の一覧です。

### 1. BARCNT.CBL

- **内容概要**: このファイルにはセンシティブな情報が含まれているため、具体的な関数や変数の説明は行えません。一般的なCOBOLプログラムの特性を踏まえると、ビジネスロジック、データベースとの連携、ファイル処理、ユーザーインターフェースを含む機能が考えられます。
  
- **役割**: 各種データ処理機能を提供し、ビジネスロジックを実行するための基本的なモジュールとして機能します。

---

### 2. JUSINJ2.CBL

- **内容概要**: このプログラムは、主にデータベースファイルの設定およびデータ構造の定義を行っています。具体的には、データファイル`JUSINJ2L`の定義、ファイルの構造とフィールドの定義が含まれています。

- **役割**:
  - **ファイル設定**: データファイルの選択、ファイルタイプの指定、レコードキーの定義など。
  - **データフィールドの定義**: さまざまなデータフィールドを`FD`文で定義し、これに関連するプロパティや構造を規定します。
  - **その他の要素**: `FILLER`フィールドの定義やプログラムのコメントによる文書化も含まれています。

---

### 3. Seigyo02.cbl

- **内容概要**: このプログラムは、特定の業務ロジックやデータ構造を定義しています。データ項目が多く、業務に特化した情報を保持する構造が特徴です。

- **役割**:
  - **データ項目の定義**: 業務で使用されるさまざまなデータ項目を定義し、それに関する詳細な情報をコメントとして記載しています。
  - **複雑なデータ構造**: 同名変数の使用により、異なる状況に対応したデータ構造を持つことが示唆されています。

---

### 4. REIGAI04.CBL

- **内容概要**: データ構造の定義と用途を示すために設計されたプログラムです。ファイルヘッダー部にプログラムの基本情報が記載されています。

- **役割**:
  - **ファイルヘッダー部**: プログラムの基本情報や目的を文書化。
  - **データセクションの構造定義**: 階層化されたデータ構造を定義し、複数のフィールドを持つ構造体を形成します。また、`FILLER`を使用し将来的な拡張を考慮した設計がなされています。

---

各ファイルは、COBOLプログラムの基本的な機能やデータ処理能力を備えており、業務ロジックを反映した異なる役割を果たしています。

## 5. 開発環境


本システムが動作する開発環境について以下に述べます。

### プラットフォーム

- **システム名**: 廮 FOR WINNDOWS
- **対象OS**: Microsoft Windows系

### プログラミング言語

- **言語**: COBOL
- **バージョン**: COBOL97

### コンパイラ

- 使用しているCOBOLコンパイラの詳細情報は非表示ですが、一般的にCOBOL言語のコンパイラは、指定したバージョンの仕様に基づいてプログラムが適切にコンパイルされることが要求されます。

### データベース

- データベースとの連携に関する詳細情報は非表示ですが、COBOLプログラムは通常、データの入出力処理を行う際にデータベースとの接続を行います。

### 関連ライブラリおよびツール

- 特定のライブラリやツールに関する情報は非表示ですが、COBOL開発には通常、デバッグや保守を容易にするためのツールが用いられます。

以上が本システムの開発環境に関する概要です。具体的な設定や詳細は、開発チームおよび運用チーム内部で管理されています。

## 6. エラーハンドリングとデバッグ


本システムにおけるエラーハンドリングのポリシー及びデバッグ方法について以下に記載します。各部品のエラー監視やデバッグのための設定、推奨するテスト手法も含めています。

### エラーハンドリングポリシー

1. **エラートラップの設定**
   - 使用されているシェルスクリプト（`install_turtlebot_simulator.sh`）では、エラー発生時にスクリプトを終了させるトラップを設定しています。書き方は次の通りです：
     ```bash
     trap 'exit 1' ERR
     ```
   - この設定により、スクリプト内でエラーが発生した制御フローを即座に停止し、エラーハンドリングを実施します。

2. **デバッグ出力の有効化**
   - 同じくシェルスクリプト内では、実行されるコマンドの詳細をデバッグ出力として表示するために、以下の設定がされています：
     ```bash
     set -x
     ```
   - これにより、問題発生源の特定が容易になり、トラブルシューティングの効率が向上します。

### デバッグ方法

1. **詳細なログ出力**
   - COBOLプログラム内での重要なロジックや条件分岐に対して、インターミディエイトなログ出力を挿入することで、実行時の状態を確認できるようにします。各データの値や進行状況をログとして出力することが推奨されます。

2. **シミュレーション環境でのテスト**
   - `install_turtlebot_simulator.sh`の機能や設定を検証するために、TurtleBotシミュレーターを使用した環境で動作確認を行います。シミュレーション環境はリアルタイムでの動作を観察可能なため、エラーパターンの洗い出しに役立ちます。

### 推奨するテスト手法

1. **ユニットテストの実施**
   - 各コンポーネント（特に制御情報マスタなどの設定情報を保持するデータ構造）に対して、ユニットテストを実施し、想定した動作を確認します。これにより、個別のロジックの信頼性を保証できます。

2. **ユーザビリティテスト**
   - システム全体が正常に機能する場合でも、ユーザビリティテストを行い、ユーザーインターフェースやユーザー体験が適切であることを確認します。これは特に医療関連システムにおいて重要です。

3. **ストレステスト**
   - システムの限界を探るために、ストレステストを行います。特に多くのユーザーが同時に接続した場合や、大量のデータを扱う場面での動作をチェックします。

4. **データベースの整合性テスト**
   - 制御情報マスタに格納されたデータが整合性を保っているか確認するために、データベースに対するテストを行います。特に、関連するデータ項目間の依存関係や整合性を確認することが重要です。

これらの手法を用いることで、システムのエラーハンドリングとデバッグを効率的に行うことができます。適切なエラーハンドリングの実装とデバッグ手法を実施することで、システムの信頼性と安定性を増すことが期待されます。

## 7. ユーザーガイド


本システムの利用者向けに、基本的な操作手順や共通する質問とその解答を以下に記載します。具体的な使用例を挙げ、実際の操作に役立つ情報を提供します。

### 1. 基本操作手順

#### 1.1. システムへのログイン
1. システム起動後、ログイン画面が表示されます。
2. ユーザー名およびパスワードを入力します。
3. 「ログイン」ボタンをクリックします。
4. 認証が成功すると、ダッシュボードが表示されます。

#### 1.2. 制御情報の定義
1. メニューから「制御情報管理」を選択します。
2. 「新規登録」ボタンをクリックして新しい制御情報を作成します。
3. 以下の項目を入力します。
   - 制御区分：0から99の数字を入力
   - 添付ファイルフォルダ：ファイル格納用のフォルダパス
   - メモパスワード：6桁のパスワード
   - 終了プログラムパス：システム終了時に起動するプログラムのパス
4. 必要な設定項目を入力後、「登録」ボタンをクリックします。

#### 1.3. 請求書関連の設定
1. 「請求書設定」メニューを開きます。
2. 各種印刷区分や振込先区分を設定します。
3. 請求書更新フラグを設定し、該当の条件に基づいて請求書の印刷可否を管理します。
4. 設定が完了したら、「保存」ボタンをクリックします。

#### 1.4. 印刷設定の管理
1. 「印刷設定」メニューに移動します。
2. 各種印刷条件を設定します。
   - 初検不可通院間隔を設定
   - 表示画面の最適化設定を行う
3. 設定が完了したら、「適用」ボタンをクリックします。

### 2. よくある質問 (FAQ)

#### Q1: 制御区分を間違えて入力してしまいました。どうすれば修正できますか？
- A1: 制御情報の一覧から該当する制御区分を選択し、「編集」ボタンをクリックして修正を行います。その後、「更新」ボタンを押して変更を保存してください。

#### Q2: 請求書関連の印刷がされません。何が問題でしょうか？
- A2: 請求書設定を確認し、印刷区分や振込先区分が正しく設定されているかチェックしてください。また、請求書更新フラグがオンになっていることを確認してください。

#### Q3: システムからログアウトするにはどうしますか？
- A3: ダッシュボードの右上にある「ログアウト」ボタンを押すことで、システムから安全にログアウトできます。

#### Q4: エラーが発生した場合の対処方法は何ですか？
- A4: エラーメッセージを確認し、指定された手順に従って問題を修正してください。それでも解決しない場合は、システム管理者に連絡し、詳細を報告してください。

### 3. 使用例

#### 3.1. 制御情報の新規登録の例
- ユーザーが「制御情報管理」で新規登録を行う際、制御区分として「01」、添付ファイルフォルダに「C:\Files」、メモパスワードに「123456」、終了プログラムパスに「C:\EndProgram.exe」を入力します。その後「登録」ボタンをクリックすることで、制御情報が保存されます。

このガイドラインに従って操作を行うことで、本システムを効率的に利用できます。さらに詳細な操作に関しては、システム内のヘルプセクションを参照してください。

## 8. セキュリティ設計


### データ保護策
本システムは、個人情報及びセンシティブなデータを扱うため、以下のデータ保護策を講じています。

1. **データアクセス制御**: 全てのデータレコードには、アクセス制御が適用されています。特に、保険情報や受診者情報など機密性の高いデータには、適切なユーザー権限がない限りアクセスできないよう制限しています。

2. **データの暗号化**: システムでは、データベース内で保存されるセンシティブなデータに対して暗号化を施しています。これにより、万が一データが外部に漏洩した場合でも、情報の解読が困難となります。

3. **データ整合性維持**: ファイルのロックモードを活用し、同時アクセスによるデータの不整合が生じないように管理しています。具体的には保険会社マスタや受診者情報ファイルに対して自動ロックモードを使用し、データの整合性を保証します。

### ユーザー認証
ユーザー認証に関しては、以下の要点を強調します。

1. **ユーザーID及びパスワードの利用**: 各ユーザーにはユニークなIDとパスワードが割り当てられ、認証後にのみシステムの利用が可能となります。適切なパスワードポリシーを設定し、強固なパスワードの使用を促進します。

2. **認証情報の管理**: 認証情報は暗号化された状態で管理され、平文での保存は行われません。また、パスワードの定期的な変更を推奨しています。

3. **セッション管理**: ユーザーのセッションは一定期間操作がない場合自動的にタイムアウトし、未使用の状態での情報漏洩を防止します。

### アクセス管理
アクセス管理の観点では、以下の内容を実施しています。

1. **ロールベースのアクセス制御 (RBAC)**: ユーザーの役割に基づいて異なるアクセス権を設定しています。例えば、管理者と一般ユーザーではアクセスできるデータや操作の範囲が異なります。

2. **監査ログの記録**: システム内での全てのユーザー操作に対して監査ログを記録し、アクセスの履歴を追跡できる体制を整えています。不正アクセスや異常な操作があった場合には、適切な対応を迅速に行えるように設計されています。

3. **定期的なアクセスレビュー**: ユーザーアカウントやアクセス権限について定期的にレビューを行い、不要な権限を削除するなどしてセキュリティを維持します。

これらのセキュリティ設計は、システムが取り扱うデータの保護と、ユーザーの信頼性を高めるために重要な施策です。引き続き最新の脅威に対応できるよう、セキュリティ対策を見直し改善していきます。

## 9. メンテナンスと更新方針


このセクションでは、システムの保守管理および更新プロセスについての要点を整理します。具体的なリリース手順と、更新に関連するベストプラクティスを記述します。

### 保守管理

1. **定期的なレビュー**:
   - システムのパフォーマンスと安定性を確保するため、定期的にコードレビューやシステムチェックを実施します。
   - バグや脆弱性が発見された場合は、迅速に修正を行うプロセスを確立します。

2. **更新履歴の管理**:
   - システム更新履歴は、 `sysupd.dat` に保存されます。この履歴は、更新の種類や日時、内容についての詳細を含み、将来的なトラブルシューティングに役立ちます。

3. **バックアップ**:
   - システム更新を行う前には常にバックアップを取得し、元の状態に戻すことが可能な体制を整えます。

### 更新プロセス

1. **リリース手順**:
   - 更新の際は、以下のステップを遵守します。
     - 事前のテスト: 新機能や修正プログラムは、本番環境に適用する前にテスト環境で十分にテストします。
     - ユーザー通知: 重大な更新がある場合、ユーザーに対して事前に通知を行います。
     - 定期メンテナンスウィンドウ: システムのダウンタイムを最小限に抑えるため、事前に定めたメンテナンスウィンドウ内で更新を行います。
     - 更新適用: フェーズ的に更新を適用し、各段階での動作確認を行います。

2. **更新前後の確認**:
   - 更新後は、システムが正常に動作しているか確認します。特に、更新履歴が正しく記録されていることを検証します。

3. **問題発生時の対応**:
   - 更新後に問題が発生した場合は、直ちに現在の状態を把握し、問題を迅速に解決します。必要に応じてロールバックを実施するための手順を整備します。

### ベストプラクティス

- **文書化**: すべての更新内容および手順を文書化し、関係者全員がアクセスできるようにします。
- **トレーニング**: 新しい機能や変更に関して、ユーザーへの教育・トレーニングを行い、システムの適切な使用を促進します。
- **フィードバック**: ユーザーからのフィードバックを定期的に収集し、改善点を次回の更新に反映させます。

これらの方針と手順に従うことで、システムのメンテナンスと更新を効率的かつ安全に実施します。

